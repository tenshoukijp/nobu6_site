%(hilight)s
<div class="content-box mb-3 content-lighten">
  <h2><i class="fa fa-book fa-fw"></i>int カスタム::On_音楽再生直前(int 再生予定番号)</h2>
  <div class="code">
    <pre class="brush:cpp;">
int カスタム::On_音楽再生直前(int 再生予定番号) {
    return -1;
}
</pre>
  </div>
</div>
<div class="content-box mb-3 content-lighten">
  <h3>引数の補足</h3>
  <ul class="pointlist">
    <li>@再生予定番号:<br>
      この直後に再生されるＢＧＭ番号。TSMod.iniに記述してある番号。<br>
  </ul>
</div>
<div class="content-box mb-3 content-lighten">
  <h3>タイミング</h3>
  <ul>
    <li>ＢＧＭが再生される度に、その直前に呼び出される。<br><br>
  </ul>
</div>
<div class="content-box mb-3 content-lighten">
  <h3>一般的用途</h3>
  <ul>
    <li>既存のＢＧＭの割り振りを、状況によってダイナミックに置き換えたい場合に利用する。
  </ul>
</div>
<div class="content-box mb-3 content-lighten">
  <h3>例①</h3>
  ここでは、ＢＧＭ置き換えでよくありがちなサンプルを紹介したい。<br>
  <p><img src="./cnt_mod/mod_snmod/cnt_mod_scenario_mod_ref_046.png"><br></p>
  上の赤枠のような曲分布は本来は、存在しない。<br>
  しかし、これを存在するかのように振るえるよう、プログラムを記述する<br>
</div>
<div class="content-box mb-3 content-lighten">
  <h3>例①</h3>
  <div class="code">
    <pre class="brush:cpp;">
int カスタム::On_音楽再生直前(int 再生予定番号) { {

  /*
     * 42:[本願寺・全地方]というのを実装してみる。
     */

  // ＢＧＭモードが_INMMで、曲分布が３８曲タイプに設定されているならば…
  if ( Get_ＴＳＭＯＤＩＮＩ設定(&quot;environment_bgm_mode&quot;) == 2 ) {

    if (  2&lt;=再生予定番号 &amp;&amp; 再生予定番号&lt;=11  ) { // [東北地方]～[九州地方]のどれかが再生される予定ならば。

      // 現在のターンが回っている大名勢力番号【配列用】を得る。
      int iDaimyoID = pターン情報.現在のターン【大名番号】-1;

      if ( 0 &lt;= iDaimyoID &amp;&amp; iDaimyoID &lt; 最大数::大名情報::配列数 ) {

        // それはプレイヤが操作している。
        if ( Is_プレイヤ担当大名( iDaimyoID ) ) {
          if ( p大名情報[iDaimyoID].家紋 == 41 ) { // 本願寺の家紋

            return 42; // 42番を再生するようにする。
          }
        }
      }
    }
  }

  // 変更しない場合-1
  return -1;
}
</pre>
  </div>
  <h4>_inmm側で増やす</h4>
  <p>後は、<a href="?page=nobu_snd_inmminmm.ini">_inmm</a>でそのようなトラックを追加(42番のトラックに対応するもの)すれば再生されます。</p>
</div>
<div class="content-box mb-3 content-lighten">
  <h3>例②</h3>
  <div class="code">
    <pre class="brush:cpp;">
int 攻撃側軍団長【武将番号】= -1;
void カスタム::On_戦争開始(戦争開始パラメタ型 パラメタ) {
  攻撃側軍団長【武将番号】 = パラメタ.攻撃側軍団長【武将番号】;
}


int カスタム::On_音楽再生直前(int 再生予定番号) {

  /*
  * 40:[戦争・政宗]というのを実装してみる。
  */

  // ＢＧＭモードが_INMMで、曲分布が３８曲タイプに設定されているならば…
  if ( Get_ＴＳＭＯＤＩＮＩ設定(&quot;environment_bgm_mode&quot;) == 2 ) {

    if ( 15&lt;=再生予定番号 &amp;&amp; 再生予定番号&lt;=20 ) { // 「戦争・緊迫」以外の戦争系の曲が流れようとしている直前！

      // 現在の戦域全域を対象として出陣している武将番号配列用のリストを得る。
      番号リスト型 list = Get_出陣中の武将番号リスト【配列用】();

      for each ( int iBushouID in list ) {

        // 伊達政宗が出陣している。
        if ( p武将戸籍情報[iBushouID].顔番号 == 顔番号::伊達政宗 &amp;&amp; Get_名字(iBushouID) == &quot;伊達&quot; &amp;&amp; Get_名前(iBushouID) == &quot;政宗&quot; ) {

          // 政宗は大名である。
          if ( p武将戸籍情報[iBushouID].状態 == 状態::大名 ) {

            // 配列にアクセスするので攻撃を仕掛けた軍団長妥当性チェック
            if ( 0 &lt;= 攻撃側軍団長【武将番号】 &amp;&amp; 攻撃側軍団長【武将番号】 &lt; 最大数::武将情報::配列数 ) {

              // 攻撃を仕掛けた軍団長の所属する大名勢力と、政宗が所属する大名勢力は同じ
              // 即ち、政宗は戦争の直接攻撃側(真っ赤ユニット勢)
              if ( p武将情報[iBushouID].所属大名【大名番号】 == p武将情報[攻撃側軍団長【武将番号】-1].所属大名【大名番号】 ) {

                // この時、「再生予定番号」に替えて、「戦争・政宗」 の音楽を流す
                return 40;
              }
            }
          }
        }
      }
    }
  }

  // 変更しない場合-1
  return -1;
}
</pre>
  </div>
</div>
<div class="content-box mb-3 content-lighten">
  <h3>例③</h3>
  <div class="code">
    <pre class="brush:cpp;">
int カスタム::On_音楽再生直前(int 再生予定番号) {

  /*
  * 41:[戦争・第六天魔王信長]というのを実装してみる。
  */

  // ＢＧＭモードが_INMMで、曲分布が３８曲タイプに設定されているならば…
  if ( Get_ＴＳＭＯＤＩＮＩ設定(&quot;environment_bgm_mode&quot;) == 2 ) {

    if ( 15&lt;=再生予定番号 &amp;&amp; 再生予定番号&lt;=20 ) { // 「戦争・緊迫」以外の戦争系の曲が流れようとしている直前！

      // 現在の戦域全域を対象として出陣している武将番号配列用のリストを得る。
      番号リスト型 list = Get_出陣中の武将番号リスト【配列用】();

      for each ( int iBushouID in list ) {

        // 織田信長が出陣している。
        if ( p武将戸籍情報[iBushouID].顔番号 == 顔番号::織田信長 &amp;&amp; Get_名字(iBushouID) == &quot;織田&quot; &amp;&amp; Get_名前(iBushouID) == &quot;信長&quot; ) {

          // 信長は大名である。
          if ( p武将戸籍情報[iBushouID].状態 == 状態::大名 ) {

            // 戦争において「攻撃」出来るのは、現在のターンが回っている大名勢力だけなので、
            // 例②の記述を考え方を変えて、次のような記述方法もある。

            // 信長が所属する大名勢力は現在のターンが回っている大名勢力、即ち、戦場にいる以上、信長は戦争の直接攻撃側(真っ赤ユニット勢)
            if ( p武将情報[iBushouID].所属大名【大名番号】 == pターン情報.現在のターン【大名番号】 ) {

              // 信長が所持する城数はすでに、50を超えるかをチェック。これを第六天魔王定義とする。
              int iDaimyoID = p武将情報[iBushouID].所属大名【大名番号】-1;
              if ( Get_大名所持城数(iDaimyoID) &gt; 50 ) {

                // この時、「再生予定番号」に替えて、[戦争・第六天魔王信長] の音楽を流す
                return 41;
              }
            }
          }
        }
      }
    }
  }

  // 変更しない場合-1
  return -1;
}
</pre>
  </div>
</div>